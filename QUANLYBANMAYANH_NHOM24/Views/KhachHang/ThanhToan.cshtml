@model IEnumerable<GioHangViewModel>

@{
    ViewData["Title"] = "Thanh toán";
}

@{
    Layout = "_KhachHangLayout";
}

<link rel="stylesheet" type="text/css" href="./../css/ThanhToan.css">


<div class="breadcrumb">
    <a href="@Url.Action("Index", "KhachVangLai")" class="home">Trang chủ</a>
    <span class="dot">•</span>
    <a class="payment">Thanh toán</a>
</div>

<div class="payment-container mt-5">
    <div class="row">
        <!-- Phần địa chỉ thanh toán -->
        <div class="payment-address col-md-6">
            <h4>Địa chỉ thanh toán</h4>
            <form asp-action="XacNhanThanhToan" method="post">
                <div class="mb-3">
                    <label for="name" class="form-label">Họ và tên <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="name" name="name" placeholder="Nhập họ và tên" required>
                </div>
                <div class="mb-3">
                    <label for="phone" class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="phone" name="phone" placeholder="Nhập số điện thoại" required>
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label">Địa chỉ</label>
                    <input type="text" class="form-control" id="address" name="address" placeholder="Nhập địa chỉ">
                </div>
                <div class="mb-3">
                    <label for="note" class="form-label">Ghi chú đơn hàng</label>
                    <textarea class="form-control" id="note" name="note" rows="3" placeholder="Lời nhắn cho người bán"></textarea>
                </div>
                <div class="methoth-payment">
                    <h4>Phương thức thanh toán</h4>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="payment" value="bank_transfer" checked>
                            <div class="icon">
                                <img src="./../images/chuyenkhoan.png" alt="Chuyển khoản ngân hàng">
                                <span>Chuyển khoản ngân hàng</span>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="payment" value="cash_on_delivery">
                            <div class="icon">
                                <img src="./../images/tienmat.png" alt="Trả tiền mặt khi nhận hàng">
                                <span>Trả tiền mặt khi nhận hàng</span>
                            </div>
                        </label>
                    </div>
                </div>
            </form>
        </div>

        <!-- Phần sản phẩm đã mua -->
        <div class="payment-product col-md-6">
            <h4>Sản phẩm đã mua</h4>
            <hr>
            <table>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>
                                <div class="img-thumbnail">
                                    <img src="@Url.Content(@item.DiaChiAnh)" alt="@item.TenSanPham">
                                </div>
                            </td>
                            <td>
                                <div class="product-info">
                                    <span class="name-product">@item.TenSanPham</span>
                                    <span class="quantity-product">SL: @item.SoLuong</span>
                                    <span class="price-product">@item.ThanhTien.ToString("C0")</span>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            <hr>
            <div class="provisional d-flex justify-content-between">
                <p>Tạm tính</p>
                <p>@ViewBag.TongThanhTien.ToString("C0")</p>
            </div>
            <div class="total d-flex justify-content-between fw-bold">
                <p>Tổng</p>
                <p>@ViewBag.TongThanhTien.ToString("C0")</p>
            </div>
            <button class="btn btn-primary w-100 mt-3" id="btnThanhToan">Thanh toán</button>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $('#btnThanhToan').click(function () {
        // Lấy dữ liệu từ các trường trong form
        var data = {
            tenNguoiNhan: $('#name').val(),
            sdtNguoiNhan: $('#phone').val(),
            diaChi: $('#address').val(),
            ghiChu: $('#note').val(),
            idPhuongThucThanhToan: $('input[name="payment"]:checked').val()
        };

        // Gửi AJAX POST request đến Controller
        $.ajax({
            url: '@Url.Action("XacNhanThanhToan", "KhachHang")', // URL của Controller
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data), // Chuyển dữ liệu sang JSON
            success: function (response) {
                if (response.success) {
                    // Nếu thành công, chuyển đến trang xác nhận
                    window.location.href = '@Url.Action("DatHangThanhCong", "KhachHang")';
                } else {
                    alert(response.message);
                }
            },
            error: function (error) {
                alert("Đã xảy ra lỗi trong quá trình thanh toán.");
                console.error(error);
            }
        });
    });
</script>

